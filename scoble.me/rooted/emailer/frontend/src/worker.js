import { marked } from 'marked';

// Mock templates (you'll need to add your actual templates here)
const templates = {
  'email-2.gotmpl': `{{ template "header" . }}

Welcome back to Week 2 of Rooted! This week, we delve deeper into connecting with God and understanding our unique identity through Him and His wondrous creation.

**Week 2 Reading Highlights**:

1. **Day One**: The focus is on God's identity and how He reveals Himself to us through His creation, Jesus Christ, and the Scriptures (p20).
  
2. **Day Two**: Discover 'Shalom' (p25), God's vision of a peaceful and harmonious world.

3. **Day Three**: Learn about our role as the crown of God's creation and the importance of community, particularly through the lens of marriage (p29).

4. **Day Four**: Explore the concept of human choice and the consequences that led to the fall of humanity and our expulsion from Eden (p33).

5. **Day Five**: Understand Jesus Christ's sacrifice as the path to our redemption (p37).

**Your Journey This Week**: We invite you to engage deeply with each day's reading by answering the reflective questions in your workbook. These questions are there to enrich our upcoming conversations. Additionally, please take a moment to write your daily prayers, connecting your thoughts and emotions with the day's theme. We look forward to sharing and growing together in our next gathering.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-3.gotmpl': `{{ template "header" . }}

Welcome back to Week 3 of Rooted!

This week, we're on a special journey to discover the channels through which God communicates with us and how we can engage in meaningful conversations with Him.

**Week 3 Reading Highlights**:

1. **Day One**: Explore how God has communicated with mankind throughout history, including through creation, other people, and circumstances.

2. **Day Two**: Dive into the Bible as God's essential medium for communication.

3. **Day Three**: Meet the Holy Spirit, our Advocate. Discover how He enlightens us with wisdom.

4. **Day Four**: Why is prayer important? Today's reading provides insights into how prayer aligns our mind and heart to better hear God's voice.

5. **Day Five**: What are effective ways to pray? Learn about methods like studying the Bible and using the PRAY acrostic.

**Your Journey This Week**: This week, we encourage you to study the excerpts provided in context (read a few verses before and after). Ask yourself, "What does this passage mean to me?" We also invite you to jot down your daily prayers. This will allow you to observe how your conversations with God evolve throughout your Rooted journey.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-4.gotmpl': `{{ template "header" . }}

We are currently in week four of Rooted. This weekend is our prayer experience. Our reading this week is about something we probably pray a lot about, suffering.

Before I talk about the prayer experience, let's go over the highlights for the reading this week.

**Week 4 Reading Highlights**:

1. **Day One**: God's got your back in the midst of your suffering.

2. **Day Two**: God is with you through the good and bad times.

4. **Day Three**: Holding on to God with the faith of Daniel.

4. **Day Four**: Discover what surrendering to God really means.

5. **Day Five**: God gave us the perfect example of how to act, Jesus. Discover how to transform your character.

**Your Journey This Week**: Suffering is a tough topic. Sometimes God can feel a universe away, but He isn't. We challenge you to sit in the uncomfortable thoughts of suffering and read Psalm 23; how can you muster that kind of faith?

**Prayer Experience**:

Saturday, 10/5 from 9am to 12pm.

We have a wonderful experience planned this weekend for you. We will meet in our normal meeting place in the Venue for the first part of the day, about 30-45 minutes. After that, you'll individually go out to find a quiet spot to pray and, most importantly, listen. After an hour of prayer, we will meet to break our fast with a light lunch and discuss our experiences.

**Fasting**:

Fasting isn't about doing without, but replacing that thing with intent.

Instead of eating food, meditate on how Jesus's early followers sat for days without food and listened to His sermons. What would that have been like? Smelled like? Sounded like?

Instead of social media, read Paul's letters (the social media of the Bible), and feel Paul's connection to the early churches in the Middle East. Maybe take a cold shower and meditate on what it would be like to be baptized in the Jordan river in 31 AD, right when Jesus started His ministry.

12 to 24 hours of fasting is recommended, but not required.
{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-5.gotmpl': `{{ template "header" . }}

**Welcome to Week 5 of Rooted: There is an enemy**

This week, we delve into the dark reality that an enemy existsâ€”Satanâ€”and he is working tirelessly to divert us from our godly path. But remember, we have powerful tools to combat this.


**Week 5 Reading Highlights**:

1. **Day One**: Understand that there is an enemyâ€”Satan. How can we remain steadfast, knowing that God will ultimately claim victory?

2. **Day Two**: Explore the spiritual realm that closely coexists with our physical world. Learn about the Armor of God and how it empowers us against the adversary.

3. **Day Three**: Confront the pervasive temptations that entice our flesh and eyes, and recognize how pride anchors these desires in our hearts and actions.

4. **Day Four**: Examine the tension between our spiritual and physical selves. What are the strategies to suppress the flesh and empower the spirit?

5. **Day Five**: Acknowledge the strongholds that we have unknowingly granted to Satan. Discover the liberation that comes from awareness, confession, and accountability in the name of Jesus.


**Your Spiritual Journey This Week**: 

Contemplate deeply on the nature of temptation this week. Listen more to the counsel of the Holy Spirit rather than succumbing to your flesh's whispers. Engage in prayer, seeking freedom from these snares.

**Strongholds Conversation**: 

This week, we will facilitate separate conversations for men and women about identifying strongholds in our lives. Prepare to discuss one or two primary strongholds you or your spouse might be battling. This session is not about quick fixes but about creating an open and safe space to share and be heard.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-6.gotmpl': `{{ template "header" . }}

Welcome to Week 6 of Rooted: How Can I Make The Most Of My Life? Part 1

Freed from the snares of the enemy, we are now invited to 'continue to work out [our] salvation with fear and trembling, for it is God who works in [us] to will and to act in order to fulfill His good purpose' (Philippians 2:12-13, NIV). Empowered by the Holy Spirit, we're called to manifest God's grace not just in words, but through purpose-driven actions that serve others.

### Week 6 Reading Highlights:

- **Day One**: Discover how God calls each one of us to serve in our own unique ways. Reflect on where you're being led to contribute positively.
  
- **Day Two**: Consider Jesus as the ultimate example for our desire to serve. What does it mean for you to serve with a similar heart?
  
- **Day Three**: Delve into the Great Commission as a universal Christian mission. How can you live out the principle of being "blessed to be a blessing"?
  
- **Day Four**: Identify where the Holy Spirit could empower you to serve others. Are there specific areas in your life you've identified?
  
- **Day Five**: Acknowledge your spiritual gifts. How can you use these gifts to make a meaningful difference in Las Vegas or in the world?

### Your Spiritual Journey This Week:

God has granted you specific gifts and talents. As you go through this week's journey, think about how you can channel these gifts to serve others through your passions, networks, and experiences.

### Glossary of the Week ðŸ“š

Unfamiliar with some terms? Don't worry, we've got you covered:

- **Snares of the Enemy**: Obstacles or spiritual traps set by Satan to derail your faith journey.
  
- **Salvation**: The deliverance from sin and entrance into a relationship with God.
  
- **Holy Spirit**: The third person of the Trinity, who empowers believers in their walk with God.
  
- **Great Commission**: Jesus' command to spread the Gospel to all nations.
  
- **Spiritual Gifts**: Special abilities given by the Holy Spirit to serve others and build up the church.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-7.gotmpl': `{{ template "header" . }}

Welcome to Week 7 of Rooted: How Can I Make The Most Of My Life? Part 2

> _[And Jesus asked] "Which of these three do you think was a neighbor to the man who fell into the hands of robbers?" The expert in the law replied, "The one who had mercy on him." Jesus told him, "Go and do likewise." - Luke 10:36-37._

### Week 7 Reading Highlights:

- **Day One**: Mercy can come from strange places. Have you ever had an enemy show you mercy? Have you shown an enemy mercy?
  
- **Day Two**: _If you love one another_ you will be known as a disciple of Jesus. Where are you called to love those less fortunate than yourself? Does "less fortunate" only refer to money, if not, what else?
  
- **Day Three**: When our cup overflows with God's spirit, how can we give that spirit to those who are poor in spirit?
  
- **Day Four**: Service as a Lifestyle. When we embody a lifestyle of service, it stops being something we __do__ and becomes something we __are__.
  
- **Day Five**: How can we bring shalom to others? Let us build and maintain relationships that multiply God's peace; the shalom we share should overflow from the other.

### Your Spiritual Journey This Week:

Please, do your homework. Write your prayers. Answer the questions. It is too easy on week 7 to get lazy and stop writing down and working the program. You will get out what you put in.

Please take the spriritual assessment; it will illuminate God's gifts for you. The assessment can help guide you on how to live a lifestyle of service.

The video for the assessment is available [here](http://email.mg.thecrossinglv.com/c/eJwczj2PpiAQAOBfgx0GRgQtLO5ysbt2s92bcRh9SUAMH_v7N7v9Uzyf8j-GePVbfmAJeESum3B_BQDllPodCFvI96swhSfw3V5XD14AiOmPAJg1nm7xVh5knDRmmuVyOpTLqYFXxmP2yw92_wa_AXhcYeBN29UZpaydhvfm0E3HsS7W-WXF9aRjJuu1QyLD0wJD2EDBpJWeQWmtYNQza-vIgXGgnbLCqHSN7c1Ucq3hvuLXSDkNcXu39tTf6S5gv0ruT2T0XOqYyyVgp15KoB57kiezF7DXJ5TQOkZ5hbNJrJVrTXy3oWyVcmvCqEr5iDwm_g4AAP__2nxjbw). You may have to scroll down the page a little to see the video player.

We will be sharing the results of the assessment during our meeting on Tuesday.

### Serve Experience

For those who could make it to the serve experience on 10/18 and 10/19, thank you. You were able to serve those in need by putting physical hope in a box. May your efforts bring some shalom to those in need.

For those who could not make it, The Crossing has many more service opportunities. From childcare to maintenance, production, and spiritual development, there is something for everyone. _Attend one, serve one_ is a pattern many people follow on Sundays to get and stay involved with our community.

### Leadership Opportunity

This group needs a leading couple for after Rooted is completed. If you are interested, please join us at 5:30pm in the Reach Cafe for a meal and conversation.

If you are interested in leading a Rooted group in the future, please also come. You will be able to learn more about it.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
  'email-8.gotmpl': `{{ template "header" . }}

Welcome to Week 8 of Rooted: How does God view money?

> _For where your treasure is, there your heart will be also. - Matthew 6:21_

### Week 8 Reading Highlights:

- **Day One**: The love __of__ money is the root of all evil, not money itself. This week, reflect on who you love more: God or money?
  
- **Day Two**: Ownership vs. Stewardship: Do you consider yourself the owner of your possessions, or are you merely a steward of God's blessings?
  
- **Day Three**: What's the difference between tithing and offerings? Have you practiced either or both?
  
- **Day Four**: Carrying the Millstone: Consider the weight of debt and how it impacts your ability to be a good steward.
  
- **Day Five**: God's Provision: Can you trust God to meet your needs, both big and small?

### Your Spiritual Journey This Week:

As we dive into the topic of money and stewardship, take some time to assess your financial habits in light of God's Word. Are you managing your resources in a way that honors God? Remember, financial stewardship is not just about managing money; it's about managing a life resource that God has entrusted to you.

{{- template "snacks" . -}}
{{- template "footer" . }}`,
};

const partials = {
  header: '{{.Name}},',
  snacks: `{{if eq .Snacks .CurrentWeek}}
You've signed up for snacks and sharing and this week is your turn to share your stories. If you'd like to wait to share your stories until later during Rooted, please let us know.
{{else if gt .Snacks .CurrentWeek}}
You've signed up for snacks and sharing for week {{.Snacks}}. If you'd like to share your stories this week, please let us know.
{{end}}`,
  footer: `
We encourage you to bring your bible with you.

God bless you,
{{.Facilitators}}`,
};

function renderTemplate(templateName, data) {
  let template = templates[templateName];
  
  // Replace {{template "name" .}} with the actual partial content
  template = template.replace(/{{[\s-]*template "(\w+)" \.[\s-]*}}/g, (_, name) => {
    if (name === 'snacks') {
      // Handle snacks logic
      const currentWeek = parseInt(data.CurrentWeek);
      const snacksWeek = parseInt(data.Snacks);
      
      if (snacksWeek === currentWeek) {
        return "You've signed up for snacks and sharing and this week is your turn to share your stories. If you'd like to wait to share your stories until later during Rooted, please let us know.";
      } else if (snacksWeek > currentWeek) {
        return `You've signed up for snacks and sharing for week ${snacksWeek}. If you'd like to share your stories this week, please let us know.`;
      } else {
        return ''; // No snacks message for this week
      }
    }
    return partials[name] || '';
  });
  
  // Replace {{.Name}} with actual data
  template = template.replace(/{{[\s-]*\.(\w+)[\s-]*}}/g, (_, key) => data[key] || '');
  
  // Handle if statements (very basic implementation)
  template = template.replace(/{{[\s-]*if (.+?)[\s-]*}}([\s\S]+?){{[\s-]*end[\s-]*}}/g, (_, condition, content) => {
    const [left, op, right] = condition.split(/\s+/);
    const leftValue = data[left.replace('.', '')] || 0;
    const rightValue = data[right.replace('.', '')] || 0;
    
    switch (op) {
      case 'eq':
        return leftValue === rightValue ? content : '';
      case 'gt':
        return leftValue > rightValue ? content : '';
      default:
        return '';
    }
  });
  
  return marked.parse(template);
}

self.addEventListener('message', (event) => {
  const { action, data } = event.data;
  
  switch (action) {
    case 'RenderTemplate':
      const renderedTemplate = renderTemplate(`email-${data.CurrentWeek}.gotmpl`, data);
      self.postMessage({
        action: 'RenderTemplateResult',
        result: {
          emailAddresses: [data.Emails[0]],
          subject: `Rooted Week ${data.CurrentWeek}`,
          body: renderedTemplate,
        },
      });
      break;
    case 'ListTemplates':
      self.postMessage({
        action: 'ListTemplatesResult',
        result: Object.keys(templates),
      });
      break;
    default:
      self.postMessage({ error: 'Unknown action' });
  }
});